name: Build and Publish

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel
        pip install -e .[test]

    - name: Run tests (if they exist)
      run: |
        if [ -d "tests" ]; then
          pytest tests/ --cov=src
        else
          echo "No tests found, skipping..."
        fi

    - name: Build package
      run: |
        echo "Building package..."
        python -m build --verbose
        echo "Build completed"

    - name: Check package
      run: |
        echo "Checking built packages..."
        twine check dist/*
        echo "Package check completed"

  build-windows:
    needs: test
    runs-on: windows-latest
    if: github.event_name == 'release'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel

    - name: Create Windows Portable Package
      run: |
        echo "Creating Windows portable package..."
        $version = "${{ github.ref_name }}"
        $version = $version -replace '^v', ''
        $packageName = "Fix_Agent_${version}_Portable_Windows"

        # åˆ›å»ºç›®å½•
        New-Item -ItemType Directory -Force -Path "dist\$packageName"

        # å¤åˆ¶wheelæ–‡ä»¶
        Get-ChildItem "dist\*.whl" | ForEach-Object {
            Copy-Item $_ -Destination "dist\$packageName\"
        }

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @"
@echo off
title Fix Agent - AIä»£ç ç¼ºé™·ä¿®å¤å·¥å…·
echo Starting Fix Agent...
echo.

python --version >nul 2>&1
if errorlevel 1 (
    echo Error: Python not found in PATH
    echo Please install Python 3.11+ and add it to PATH
    pause
    exit /b 1
)

python -m Fix_agent %*

if errorlevel 1 (
    echo.
    echo Fix Agent exited with an error
    pause
)
"@ | Out-File -FilePath "dist\$packageName\Fix_Agent.bat" -Encoding UTF8

        # å¤åˆ¶æ–‡æ¡£
        @("README.md", "LICENSE") | ForEach-Object {
            if (Test-Path $_) {
                Copy-Item $_ -Destination "dist\$packageName\"
            }
        }

        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path "dist\$packageName\*" -DestinationPath "dist\$packageName.zip" -Force

        Write-Host "Windows package created: $packageName.zip"
      shell: powershell

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-artifacts
        path: |
          dist/Fix_Agent_*_Portable_Windows.zip

  publish:
    needs: [test, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: python -m build

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Fix Agent ${{ github.ref_name }}
        body: |
          ## Fix Agent ${{ github.ref_name }}

          ### ğŸš€ æ–°ç‰¹æ€§
          - PowerShellå®Œæ•´æ”¯æŒ
          - WindowsæœåŠ¡ç®¡ç†åŠŸèƒ½
          - WSLç¯å¢ƒæ£€æµ‹
          - è·¨å¹³å°è·¯å¾„å¤„ç†
          - æ™ºèƒ½ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤º

          ### ğŸ“¦ å®‰è£…æ–¹å¼
          1. **æ¨è**: `pip install Fix_agent`
          2. **ä¾¿æºç‰ˆ**: ä¸‹è½½ Assets ä¸­çš„ Windows ZIP åŒ…
          3. **å¼€å‘ç‰ˆ**: `pip install git+https://github.com/3uyuan1ee/Fix_agent.git`

          ### ğŸªŸ Windowsç‰¹å®šåŠŸèƒ½
          ```cmd
          # ç³»ç»Ÿä¿¡æ¯
          fix-agent
          > /sys

          # æœåŠ¡ç®¡ç†
          fix-agent
          > /services list
          > /services start mysql

          # PowerShellå‘½ä»¤
          fix-agent
          ! pwsh Get-Process
          ```

          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - Python 3.11+
          - Windows 10/11
          - å¯é€‰: Node.js (JavaScripté¡¹ç›®åˆ†æ)

          ğŸ“š [å®Œæ•´æ–‡æ¡£](https://github.com/3uyuan1ee/Fix_agent#readme)
          ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/3uyuan1ee/Fix_agent/issues)
        draft: false
        prerelease: false

    - name: Download Windows artifacts
      uses: actions/download-artifact@v3
      with:
        name: windows-artifacts
        path: dist/

    - name: Upload Release Assets
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # è·å–ä¸Šä¼ URL
        UPLOAD_URL=$(curl -s \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}" | \
          jq -r '.upload_url')

        # ä¸Šä¼ Windowsä¾¿æºåŒ…
        for file in dist/*.zip; do
          if [ -f "$file" ]; then
            echo "Uploading $file..."
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "$UPLOAD_URL?name=$(basename "$file")"
          fi
        done

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*

    - name: Publish to Test PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        twine upload --repository testpypi dist/*