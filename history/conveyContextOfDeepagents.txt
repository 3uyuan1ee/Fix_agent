å®Œæ•´è®°å¿†ä¼ é€’æ–¹æ¡ˆ

  éœ€è¦ä¼ é€’çš„å†…å®¹

  1. å¯¹è¯å†å² (messages) - å®Œæ•´çš„æ¨ç†è¿‡ç¨‹
  2. ä»»åŠ¡çŠ¶æ€ (todos) - ä»»åŠ¡è§„åˆ’å’Œæ‰§è¡ŒçŠ¶æ€
  3. æ–‡ä»¶å†…å®¹ (files) - ä»£ç†ç§¯ç´¯çš„æ–‡ä»¶çŸ¥è¯†
  4. æ¨ç†è½¨è¿¹ (reasoning_trace) - è¯¦ç»†çš„æ€è€ƒè¿‡ç¨‹
  5. å·¥å…·è°ƒç”¨å†å² (tool_calls) - æ‰€æœ‰å·¥å…·è°ƒç”¨è®°å½•

  ğŸ› ï¸ çŠ¶æ€å¯¼å‡º/å¯¼å…¥å·¥å…·è®¾è®¡

  å·¥å…·1ï¼šçŠ¶æ€å¯¼å‡ºå·¥å…·

  from langchain_core.tools import tool
  import json
  import time
  from typing import Dict, Any
  from pathlib import Path

  @tool
  def export_agent_state(
      export_path: str,
      include_reasoning: bool = True,
      include_files: bool = True,
      include_todos: bool = True
  ) -> str:
      """
      å¯¼å‡ºå½“å‰ä»£ç†çš„å®Œæ•´çŠ¶æ€åˆ°æ–‡ä»¶

      Args:
          export_path: å¯¼å‡ºæ–‡ä»¶è·¯å¾„
          include_reasoning: æ˜¯å¦åŒ…å«æ¨ç†è¿‡ç¨‹
          include_files: æ˜¯å¦åŒ…å«æ–‡ä»¶å†…å®¹
          include_todos: æ˜¯å¦åŒ…å«ä»»åŠ¡çŠ¶æ€

      Returns:
          å¯¼å‡ºç»“æœæè¿°
      """
      # è¿™ä¸ªå·¥å…·ä¼šè¢«ä»£ç†è°ƒç”¨ï¼Œè‡ªåŠ¨è·å–å½“å‰çŠ¶æ€
      return f"""
      çŠ¶æ€å¯¼å‡ºä»»åŠ¡ï¼š
      - å¯¼å‡ºè·¯å¾„: {export_path}
      - åŒ…å«æ¨ç†: {include_reasoning}
      - åŒ…å«æ–‡ä»¶: {include_files}
      - åŒ…å«ä»»åŠ¡: {include_todos}

      è¯·æŒ‰ä»¥ä¸‹æ ¼å¼å¯¼å‡ºçŠ¶æ€ï¼š

      1. ä½¿ç”¨ write_file åˆ›å»ºä¸»çŠ¶æ€æ–‡ä»¶: {export_path}/agent_state.json
      2. ä½¿ç”¨ write_file åˆ›å»ºæ¨ç†è½¨è¿¹æ–‡ä»¶: {export_path}/reasoning_trace.md
      3. å¦‚æœ include_files=Trueï¼Œå¤åˆ¶ç›¸å…³æ–‡ä»¶åˆ° {export_path}/files/
      4. åˆ›å»ºçŠ¶æ€ç´¢å¼•æ–‡ä»¶: {export_path}/state_index.json

      çŠ¶æ€æ–‡ä»¶åº”åŒ…å«ï¼š
      - messages: å®Œæ•´å¯¹è¯å†å²
      - todos: å½“å‰ä»»åŠ¡çŠ¶æ€
      - reasoning_summary: æ¨ç†è¿‡ç¨‹æ‘˜è¦
      - tool_call_history: å·¥å…·è°ƒç”¨è®°å½•
      - timestamp: å¯¼å‡ºæ—¶é—´æˆ³
      - metadata: ä»£ç†å…ƒä¿¡æ¯
      """

  @tool
  def import_agent_state(import_path: str, merge_strategy: str = "replace") -> str:
      """
      ä»æ–‡ä»¶å¯¼å…¥å¦ä¸€ä¸ªä»£ç†çš„çŠ¶æ€

      Args:
          import_path: çŠ¶æ€æ–‡ä»¶è·¯å¾„
          merge_strategy: åˆå¹¶ç­–ç•¥ (replace/merge/append)

      Returns:
          å¯¼å…¥ç»“æœæè¿°
      """
      return f"""
      çŠ¶æ€å¯¼å…¥ä»»åŠ¡ï¼š
      - å¯¼å…¥è·¯å¾„: {import_path}
      - åˆå¹¶ç­–ç•¥: {merge_strategy}

      è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å¯¼å…¥çŠ¶æ€ï¼š

      1. ä½¿ç”¨ read_file è¯»å–ä¸»çŠ¶æ€æ–‡ä»¶: {import_path}/agent_state.json
      2. ä½¿ç”¨ read_file è¯»å–æ¨ç†è½¨è¿¹: {import_path}/reasoning_trace.md
      3. å¦‚æœå­˜åœ¨æ–‡ä»¶ç›®å½•ï¼Œä½¿ç”¨ ls æŸ¥çœ‹ {import_path}/files/ å†…å®¹
      4. æ ¹æ®åˆå¹¶ç­–ç•¥å¤„ç†å¯¼å…¥çš„çŠ¶æ€ï¼š

      ç­–ç•¥è¯´æ˜ï¼š
      - replace: å®Œå…¨æ›¿æ¢å½“å‰çŠ¶æ€
      - merge: æ™ºèƒ½åˆå¹¶ï¼Œä¿ç•™å½“å‰é‡è¦ä¿¡æ¯
      - append: è¿½åŠ æ¨¡å¼ï¼Œä¿ç•™æ‰€æœ‰å†å²

      è¯·ï¼š
      1. åˆ†æå¯¼å…¥çš„çŠ¶æ€å†…å®¹
      2. æ ¹æ®ç­–ç•¥è°ƒæ•´è‡ªå·±çš„ä¸Šä¸‹æ–‡
      3. æ›´æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      4. å‡†å¤‡åŸºäºå¯¼å…¥çŠ¶æ€ç»§ç»­å·¥ä½œ
      """

  @tool
  def create_continuation_prompt(
      previous_agent_role: str,
      current_agent_role: str,
      transition_context: str
  ) -> str:
      """
      åˆ›å»ºä»£ç†é—´çš„è¡”æ¥æç¤º

      Args:
          previous_agent_role: å‰ä¸€ä¸ªä»£ç†çš„è§’è‰²
          current_agent_role: å½“å‰ä»£ç†çš„è§’è‰²
          transition_context: è½¬æ¢ä¸Šä¸‹æ–‡

      Returns:
          è¡”æ¥æç¤ºå†…å®¹
      """
      return f"""
      è¯·åˆ›å»ºä¸€ä¸ªä» {previous_agent_role} åˆ° {current_agent_role} çš„è¡”æ¥æç¤ºï¼š

      è½¬æ¢ä¸Šä¸‹æ–‡: {transition_context}

      æç¤ºåº”åŒ…å«ï¼š
      1. ç¡®è®¤ç†è§£å‰ä¸€ä¸ªä»£ç†çš„å·¥ä½œæˆæœ
      2. æ˜ç¡®å½“å‰ä»£ç†çš„èŒè´£å’Œç›®æ ‡
      3. è¯´æ˜å¦‚ä½•åˆ©ç”¨å¯¼å…¥çš„çŠ¶æ€ä¿¡æ¯
      4. å®šä¹‰æˆåŠŸæ ‡å‡†å’Œä¸‹ä¸€æ­¥è¡ŒåŠ¨
      """

  å·¥å…·2ï¼šæ¨ç†è¿‡ç¨‹è®°å½•å·¥å…·

  @tool
  def record_reasoning_step(
      step_description: str,
      step_type: str = "analysis",
      confidence: float = 0.8,
      next_actions: list = None
  ) -> str:
      """
      è®°å½•æ¨ç†è¿‡ç¨‹ä¸­çš„å…³é”®æ­¥éª¤

      Args:
          step_description: æ­¥éª¤æè¿°
          step_type: æ­¥éª¤ç±»å‹ (analysis/decision/action/verification)
          confidence: ä¿¡å¿ƒåº¦ (0-1)
          next_actions: åç»­è¡ŒåŠ¨åˆ—è¡¨

      Returns:
          è®°å½•ç¡®è®¤ä¿¡æ¯
      """
      return f"""
      è¯·è®°å½•æ¨ç†æ­¥éª¤ï¼š

      æ­¥éª¤æè¿°: {step_description}
      æ­¥éª¤ç±»å‹: {step_type}
      ä¿¡å¿ƒåº¦: {confidence}
      åç»­è¡ŒåŠ¨: {next_actions or []}

      è¯·ä½¿ç”¨ write_file å°†æ­¤æ­¥éª¤è¿½åŠ åˆ°å½“å‰æ¨ç†è½¨è¿¹æ–‡ä»¶ä¸­ã€‚
      æ ¼å¼ï¼š

      ## {step_type.upper()} - {time.strftime('%H:%M:%S')}
      **æè¿°**: {step_description}
      **ä¿¡å¿ƒåº¦**: {confidence}
      **åç»­è¡ŒåŠ¨**: {', '.join(next_actions or [])}

      ---
      """

  @tool
  def create_reasoning_summary(
      objective: str,
      key_findings: list,
      decisions_made: list,
      confidence_score: float
  ) -> str:
      """
      åˆ›å»ºæ¨ç†è¿‡ç¨‹æ‘˜è¦

      Args:
          objective: åŸå§‹ç›®æ ‡
          key_findings: å…³é”®å‘ç°åˆ—è¡¨
          decisions_made: é‡è¦å†³ç­–åˆ—è¡¨
          confidence_score: æ•´ä½“ä¿¡å¿ƒåˆ†æ•°

      Returns:
          æ‘˜è¦åˆ›å»ºç¡®è®¤
      """
      return f"""
      è¯·åˆ›å»ºæ¨ç†è¿‡ç¨‹æ‘˜è¦ï¼š

      åŸå§‹ç›®æ ‡: {objective}
      å…³é”®å‘ç°: {key_findings}
      é‡è¦å†³ç­–: {decisions_made}
      ä¿¡å¿ƒåˆ†æ•°: {confidence_score}

      è¯·ä½¿ç”¨ write_file åˆ›å»ºç»“æ„åŒ–çš„æ¨ç†æ‘˜è¦ï¼ŒåŒ…å«ï¼š
      1. ç›®æ ‡è¾¾æˆæƒ…å†µåˆ†æ
      2. å…³é”®æ¨ç†è·¯å¾„æ¢³ç†
      3. å†³ç­–ä¾æ®å’Œé£é™©è¯„ä¼°
      4. å¯¹ä¸‹ä¸€ä»£ç†çš„å»ºè®®
      """

  ğŸ—ï¸ ä¸‰ä»£ç†å®Œæ•´æ¶æ„

  ä»£ç†1ï¼šé—®é¢˜æ£€æµ‹ä»£ç†ï¼ˆå¸¦å®Œæ•´çŠ¶æ€å¯¼å‡ºï¼‰

  issue_detector = create_deep_agent(
      tools=[
          # ç°æœ‰å·¥å…·
          static_analyzer, security_scanner, ls, read_file, write_file,
          # æ–°å¢çŠ¶æ€ç®¡ç†å·¥å…·
          export_agent_state, record_reasoning_step, create_reasoning_summary
      ],
      system_prompt="""ä½ æ˜¯é—®é¢˜æ£€æµ‹ä¸“å®¶ï¼Œè´Ÿè´£ï¼š

      1. æ·±åº¦åˆ†æä»£ç åº“ï¼Œå‘ç°å„ç±»é—®é¢˜
      2. è¯¦ç»†è®°å½•ä½ çš„æ¨ç†è¿‡ç¨‹å’Œå†³ç­–ä¾æ®
      3. åˆ›å»ºå®Œæ•´çš„é—®é¢˜æŠ¥å‘Šå’Œåˆ†æè½¨è¿¹
      4. å¯¼å‡ºå®Œæ•´çŠ¶æ€ä¾›ä¸‹ä¸€ä¸ªä»£ç†ä½¿ç”¨

      å·¥ä½œæµç¨‹ï¼š
      - ä½¿ç”¨ record_reasoning_step è®°å½•æ¯ä¸ªå…³é”®æ¨ç†æ­¥éª¤
      - ä½¿ç”¨ create_reasoning_summary åˆ›å»ºåˆ†ææ‘˜è¦
      - æœ€åä½¿ç”¨ export_agent_state å¯¼å‡ºå®Œæ•´çŠ¶æ€åˆ° /workspace/transfer/detection_state/

      çŠ¶æ€å¯¼å‡ºè¦æ±‚ï¼š
      - åŒ…å«å®Œæ•´çš„å¯¹è¯å†å²å’Œæ¨ç†è¿‡ç¨‹
      - åŒ…å«æ‰€æœ‰å‘ç°çš„é—®é¢˜å’Œåˆ†æä¾æ®
      - åŒ…å«æ–‡ä»¶æ‰«æè½¨è¿¹å’Œå·¥å…·è°ƒç”¨è®°å½•
      - ä¸ºä¿®å¤ä»£ç†æä¾›å……åˆ†ä¸Šä¸‹æ–‡"""
  )

  ä»£ç†2ï¼šä¿®å¤æ–¹æ¡ˆç”Ÿæˆä¸æ‰§è¡Œä»£ç†ï¼ˆå¸¦çŠ¶æ€å¯¼å…¥å’Œå¯¼å‡ºï¼‰

  fix_generator = create_deep_agent(
      tools=[
          # ç°æœ‰å·¥å…·
          code_formatter, auto_fixer, patch_tool, ls, read_file, write_file,
          # æ–°å¢çŠ¶æ€ç®¡ç†å·¥å…·
          import_agent_state, export_agent_state, record_reasoning_step,
          create_continuation_prompt
      ],
      system_prompt="""ä½ æ˜¯ä¿®å¤ä¸“å®¶ï¼Œè´Ÿè´£ï¼š

      1. å¯¼å…¥å¹¶ç†è§£é—®é¢˜æ£€æµ‹ä»£ç†çš„å®Œæ•´çŠ¶æ€
      2. åŸºäºå‰ä¸€ä¸ªä»£ç†çš„æ¨ç†è¿‡ç¨‹åˆ¶å®šä¿®å¤ç­–ç•¥
      3. è®°å½•è‡ªå·±çš„ä¿®å¤å†³ç­–è¿‡ç¨‹
      4. æ‰§è¡Œä¿®å¤å¹¶å¯¼å‡ºçŠ¶æ€ç»™éªŒè¯ä»£ç†

      å·¥ä½œæµç¨‹ï¼š
      1. ä½¿ç”¨ import_agent_state å¯¼å…¥ /workspace/transfer/detection_state/ çš„çŠ¶æ€
      2. ä½¿ç”¨ create_continuation_prompt åˆ›å»ºè¡”æ¥æç¤º
      3. åˆ†æå‰ä¸€ä¸ªä»£ç†çš„æ¨ç†è¿‡ç¨‹å’Œé—®é¢˜å‘ç°
      4. è®°å½•ä¿®å¤æ–¹æ¡ˆçš„æ¨ç†è¿‡ç¨‹
      5. æ‰§è¡Œä¿®å¤å¹¶è®°å½•æ¯ä¸ªæ­¥éª¤
      6. ä½¿ç”¨ export_agent_state å¯¼å‡ºçŠ¶æ€åˆ° /workspace/transfer/fix_state/

      çŠ¶æ€å¤„ç†ç­–ç•¥ï¼š
      - ä½¿ç”¨ merge ç­–ç•¥åˆå¹¶æ£€æµ‹ä»£ç†çš„çŠ¶æ€
      - ä¿æŒå¯¹é—®é¢˜æ£€æµ‹è¿‡ç¨‹çš„å®Œæ•´ç†è§£
      - æ·»åŠ ä¿®å¤å†³ç­–çš„è¯¦ç»†æ¨ç†è¿‡ç¨‹
      - ä¸ºéªŒè¯ä»£ç†æä¾›ä¿®å¤å‰åçš„å®Œæ•´ä¸Šä¸‹æ–‡"""
  )

  ä»£ç†3ï¼šéªŒè¯ä»£ç†ï¼ˆå¸¦çŠ¶æ€å¯¼å…¥ï¼‰

  validator = create_deep_agent(
      tools=[
          # ç°æœ‰å·¥å…·
          test_runner, verification_tool, regression_tester, ls, read_file, write_file,
          # æ–°å¢çŠ¶æ€ç®¡ç†å·¥å…·
          import_agent_state, create_continuation_prompt, record_reasoning_step
      ],
      system_prompt="""ä½ æ˜¯éªŒè¯ä¸“å®¶ï¼Œè´Ÿè´£ï¼š

      1. å¯¼å…¥å‰ä¸¤ä¸ªä»£ç†çš„å®Œæ•´çŠ¶æ€
      2. ç†è§£é—®é¢˜å‘ç°å’Œä¿®å¤çš„å®Œæ•´è¿‡ç¨‹
      3. éªŒè¯ä¿®å¤çš„æœ‰æ•ˆæ€§å’Œå®Œæ•´æ€§
      4. ç”Ÿæˆæœ€ç»ˆéªŒè¯æŠ¥å‘Š

      å·¥ä½œæµç¨‹ï¼š
      1. ä½¿ç”¨ import_agent_state å¯¼å…¥ä¿®å¤çŠ¶æ€ /workspace/transfer/fix_state/
      2. åˆ†æä»é—®é¢˜æ£€æµ‹åˆ°ä¿®å¤çš„å®Œæ•´é“¾æ¡
      3. è®¾è®¡éªŒè¯ç­–ç•¥å¹¶è®°å½•æ¨ç†è¿‡ç¨‹
      4. æ‰§è¡ŒéªŒè¯å¹¶è®°å½•ç»“æœ
      5. ç”ŸæˆåŒ…å«å®Œæ•´è¿‡ç¨‹è¿½æº¯çš„æœ€ç»ˆæŠ¥å‘Š

      éªŒè¯é‡ç‚¹ï¼š
      - ç¡®è®¤åŸå§‹é—®é¢˜å·²è§£å†³
      - æ£€æŸ¥ä¿®å¤æ˜¯å¦å¼•å…¥æ–°é—®é¢˜
      - éªŒè¯ä¿®å¤è´¨é‡å’Œæ€§èƒ½å½±å“
      - æä¾›å®Œæ•´çš„è¿‡ç¨‹å®¡è®¡è½¨è¿¹"""
  )

  ğŸ“ çŠ¶æ€ä¼ é€’æ–‡ä»¶ç»“æ„

  /workspace/transfer/
  â”œâ”€â”€ detection_state/              # ä»£ç†1çš„çŠ¶æ€å¯¼å‡º
  â”‚   â”œâ”€â”€ agent_state.json         # ä¸»çŠ¶æ€æ–‡ä»¶
  â”‚   â”œâ”€â”€ reasoning_trace.md       # æ¨ç†è½¨è¿¹
  â”‚   â”œâ”€â”€ files/                   # ç›¸å…³æ–‡ä»¶å‰¯æœ¬
  â”‚   â”‚   â”œâ”€â”€ scanned_files/
  â”‚   â”‚   â””â”€â”€ analysis_results/
  â”‚   â”œâ”€â”€ tool_call_history.json   # å·¥å…·è°ƒç”¨å†å²
  â”‚   â””â”€â”€ state_index.json         # çŠ¶æ€ç´¢å¼•
  â”œâ”€â”€ fix_state/                   # ä»£ç†2çš„çŠ¶æ€å¯¼å‡º
  â”‚   â”œâ”€â”€ agent_state.json
  â”‚   â”œâ”€â”€ reasoning_trace.md
  â”‚   â”œâ”€â”€ files/
  â”‚   â”‚   â”œâ”€â”€ fixes_applied/
  â”‚   â”‚   â””â”€â”€ modified_files/
  â”‚   â”œâ”€â”€ tool_call_history.json
  â”‚   â””â”€â”€ state_index.json
  â””â”€â”€ final_validation/            # æœ€ç»ˆéªŒè¯ç»“æœ
      â”œâ”€â”€ complete_workflow_report.md
      â”œâ”€â”€ validation_summary.json
      â””â”€â”€ process_audit_trail.json

  ğŸ”„ åè°ƒè„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰

  class EnhancedThreeAgentCoordinator:
      def __init__(self, workspace="/workspace"):
          self.workspace = Path(workspace)
          self.transfer_dir = self.workspace / "transfer"
          self.setup_workspace()

      def setup_workspace(self):
          """åˆ›å»ºå·¥ä½œç›®å½•ç»“æ„"""
          dirs = [
              "transfer/detection_state",
              "transfer/fix_state",
              "transfer/final_validation",
              "issues", "fixes", "validation"
          ]
          for dir_path in dirs:
              (self.workspace / dir_path).mkdir(parents=True, exist_ok=True)

      def coordinate_workflow(self, project_path):
          """åè°ƒå®Œæ•´çš„å¸¦çŠ¶æ€ä¼ é€’çš„å·¥ä½œæµç¨‹"""

          print("ğŸ” é˜¶æ®µ1: é—®é¢˜æ£€æµ‹ä¸çŠ¶æ€å¯¼å‡º...")
          self.run_detection_with_state_export(project_path)

          print("ğŸ”§ é˜¶æ®µ2: ä¿®å¤æ–¹æ¡ˆç”Ÿæˆä¸çŠ¶æ€ä¼ é€’...")
          self.run_fix_with_state_transfer()

          print("âœ… é˜¶æ®µ3: éªŒè¯ä¸æœ€ç»ˆæŠ¥å‘Š...")
          self.run_validation_with_complete_history()

          return self.generate_complete_workflow_report()

      def run_detection_with_state_export(self, project_path):
          """è¿è¡Œæ£€æµ‹ä»£ç†å¹¶å¯¼å‡ºå®Œæ•´çŠ¶æ€"""
          detection_prompt = f"""
          è¯·åˆ†æé¡¹ç›® {project_path} å¹¶ï¼š
          1. æ·±åº¦æ‰«æä»£ç åº“ï¼Œå‘ç°æ‰€æœ‰é—®é¢˜
          2. è¯¦ç»†è®°å½•æ¯ä¸ªå‘ç°å’Œæ¨ç†è¿‡ç¨‹
          3. ä½¿ç”¨ record_reasoning_step è®°å½•å…³é”®æ­¥éª¤
          4. æœ€åä½¿ç”¨ export_agent_state å°†å®Œæ•´çŠ¶æ€å¯¼å‡ºåˆ° {self.transfer_dir}/detection_state/

          ç¡®ä¿çŠ¶æ€åŒ…å«ï¼š
          - å®Œæ•´çš„é—®é¢˜å‘ç°è¿‡ç¨‹
          - æ¯ä¸ªé—®é¢˜çš„åˆ†æä¾æ®
          - æ‰«æçš„æ–‡ä»¶å’Œå·¥å…·è°ƒç”¨è®°å½•
          - æ¨ç†è½¨è¿¹å’Œå†³ç­–è¿‡ç¨‹
          """

          # issue_detector.invoke({"messages": [{"role": "user", "content": detection_prompt}]})
          print("âœ… æ£€æµ‹å®Œæˆï¼ŒçŠ¶æ€å·²å¯¼å‡º")

      def run_fix_with_state_transfer(self):
          """è¿è¡Œä¿®å¤ä»£ç†ï¼Œå¯¼å…¥å‰ä¸€ä¸ªä»£ç†çš„çŠ¶æ€"""
          fix_prompt = f"""
          è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å·¥ä½œï¼š
          1. ä½¿ç”¨ import_agent_state å¯¼å…¥ {self.transfer_dir}/detection_state/ çš„çŠ¶æ€
          2. ä½¿ç”¨ create_continuation_prompt åˆ›å»ºä»æ£€æµ‹åˆ°ä¿®å¤çš„è¡”æ¥
          3. åŸºäºå¯¼å…¥çš„å®Œæ•´æ¨ç†è¿‡ç¨‹åˆ¶å®šä¿®å¤ç­–ç•¥
          4. è®°å½•ä¿®å¤å†³ç­–çš„è¯¦ç»†æ¨ç†è¿‡ç¨‹
          5. æ‰§è¡Œä¿®å¤å¹¶ä½¿ç”¨ export_agent_state å¯¼å‡ºåˆ° {self.transfer_dir}/fix_state/
          """

          # fix_generator.invoke({"messages": [{"role": "user", "content": fix_prompt}]})
          print("âœ… ä¿®å¤å®Œæˆï¼ŒçŠ¶æ€å·²ä¼ é€’")

      def run_validation_with_complete_history(self):
          """è¿è¡ŒéªŒè¯ä»£ç†ï¼Œå…·å¤‡å®Œæ•´å†å²ä¸Šä¸‹æ–‡"""
          validation_prompt = f"""
          è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å·¥ä½œï¼š
          1. ä½¿ç”¨ import_agent_state å¯¼å…¥ {self.transfer_dir}/fix_state/ çš„çŠ¶æ€
          2. åˆ†æä»é—®é¢˜æ£€æµ‹åˆ°ä¿®å¤çš„å®Œæ•´è¿‡ç¨‹
          3. åŸºäºå®Œæ•´ä¸Šä¸‹æ–‡è®¾è®¡éªŒè¯ç­–ç•¥
          4. æ‰§è¡ŒéªŒè¯å¹¶è®°å½•è¿‡ç¨‹
          5. ç”ŸæˆåŒ…å«å®Œæ•´è¿‡ç¨‹è¿½æº¯çš„æœ€ç»ˆæŠ¥å‘Š
          """

          # validator.invoke({"messages": [{"role": "user", "content": validation_prompt}]})
          print("âœ… éªŒè¯å®Œæˆï¼Œæœ€ç»ˆæŠ¥å‘Šå·²ç”Ÿæˆ")

      def generate_complete_workflow_report(self):
          """ç”Ÿæˆå®Œæ•´å·¥ä½œæµç¨‹æŠ¥å‘Š"""
          report = {
              "workflow_metadata": {
                  "start_time": time.time(),
                  "workspace": str(self.workspace),
                  "agents_sequence": ["issue_detector", "fix_generator", "validator"]
              },
              "state_transfer_chain": {
                  "detection_state": str(self.transfer_dir / "detection_state"),
                  "fix_state": str(self.transfer_dir / "fix_state"),
                  "final_validation": str(self.transfer_dir / "final_validation")
              },
              "complete_reasoning_chain": self.assemble_reasoning_chain(),
              "final_outcomes": self.load_final_validation()
          }

          report_path = self.workspace / "complete_workflow_report.json"
          report_path.write_text(json.dumps(report, indent=2, ensure_ascii=False))

          return report_path

      def assemble_reasoning_chain(self):
          """ç»„è£…å®Œæ•´çš„æ¨ç†é“¾"""
          reasoning_chain = []

          # ä»æ¯ä¸ªçŠ¶æ€ä¸­æå–æ¨ç†è½¨è¿¹
          for state_dir in ["detection_state", "fix_state"]:
              reasoning_file = self.transfer_dir / state_dir / "reasoning_trace.md"
              if reasoning_file.exists():
                  reasoning_chain.append({
                      "agent": state_dir.replace("_state", ""),
                      "reasoning_trace": reasoning_file.read_text()
                  })

          return reasoning_chain

      def load_final_validation(self):
          """åŠ è½½æœ€ç»ˆéªŒè¯ç»“æœ"""
          validation_file = self.transfer_dir / "final_validation" / "validation_summary.json"
          if validation_file.exists():
              return json.loads(validation_file.read_text())
          return {}

  ğŸ¯ å…³é”®ä¼˜åŠ¿

  è¿™ä¸ªæ–¹æ¡ˆæä¾›ï¼š

  1. å®Œæ•´çš„è®°å¿†ä¼ é€’ âœ…
    - å¯¹è¯å†å²ã€æ¨ç†è¿‡ç¨‹ã€ä»»åŠ¡çŠ¶æ€å…¨éƒ¨ä¼ é€’
    - æ¯ä¸ªä»£ç†éƒ½èƒ½ç†è§£å‰ä¸€ä¸ªä»£ç†çš„å®Œæ•´å·¥ä½œè¿‡ç¨‹
  2. æ¨ç†è¿‡ç¨‹é€æ˜ âœ…
    - è¯¦ç»†è®°å½•æ¯ä¸ªå†³ç­–çš„ä¾æ®
    - å¯è¿½æº¯å®Œæ•´çš„é—®é¢˜â†’ä¿®å¤â†’éªŒè¯é“¾æ¡
  3. æ™ºèƒ½çŠ¶æ€ç®¡ç† âœ…
    - æ”¯æŒå¤šç§åˆå¹¶ç­–ç•¥ï¼ˆæ›¿æ¢/åˆå¹¶/è¿½åŠ ï¼‰
    - é¿å…ä¿¡æ¯ä¸¢å¤±å’ŒçŠ¶æ€å†²çª
  4. çµæ´»çš„æ‰©å±•æ€§ âœ…
    - å®¹æ˜“æ·»åŠ æ–°çš„ä»£ç†æˆ–ä¿®æ”¹æµç¨‹
    - å·¥å…·å¯ä»¥å¤ç”¨å’Œç»„åˆ
