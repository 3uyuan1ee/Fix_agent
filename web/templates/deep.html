{% extends "base.html" %}

{% block title %}深度分析 - AIDefectDetector{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/chat.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- 会话历史侧边栏 -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-brain me-2"></i>
                深度分析
            </div>
            <button class="sidebar-toggle-btn" id="sidebarToggleBtn">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- 新建会话按钮 -->
        <div class="new-chat-section">
            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus me-2"></i>
                新建会话
            </button>
        </div>

        <!-- 会话列表 -->
        <div class="chat-sessions">
            <div class="sessions-header">
                <h6>会话历史</h6>
                <button class="clear-sessions-btn" id="clearSessionsBtn" title="清空历史">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="sessions-list" id="sessionsList">
                <!-- 会话列表将动态填充 -->
                <div class="no-sessions">
                    <i class="fas fa-comments me-2"></i>
                    暂无会话记录
                </div>
            </div>
        </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="chat-main">
        <!-- 顶部工具栏 -->
        <div class="chat-toolbar">
            <div class="toolbar-left">
                <button class="mobile-sidebar-toggle" id="mobileSidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="current-session-info">
                    <h5 class="session-title" id="currentSessionTitle">新建会话</h5>
                    <span class="session-status" id="sessionStatus">
                        <span class="status-dot"></span>
                        就绪
                    </span>
                </div>
            </div>
            <div class="toolbar-right">
                <div class="context-selector">
                    <button class="context-btn" id="contextBtn" title="选择项目上下文">
                        <i class="fas fa-folder-open me-1"></i>
                        项目上下文
                    </button>
                </div>
                <div class="toolbar-actions">
                    <button class="action-btn" id="exportChatBtn" title="导出会话">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn" id="settingsBtn" title="设置">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 聊天消息区域 -->
        <div class="chat-messages" id="chatMessages">
            <!-- 欢迎消息 -->
            <div class="welcome-message" id="welcomeMessage">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3>欢迎使用深度分析</h3>
                    <p>我是AIDefectDetector的AI助手，可以帮助您进行深度代码分析。</p>
                    <div class="welcome-suggestions">
                        <div class="suggestion-chip" data-suggestion="请分析这个项目的安全漏洞">
                            <i class="fas fa-shield-alt me-1"></i>
                            分析安全漏洞
                        </div>
                        <div class="suggestion-chip" data-suggestion="帮我找出代码中的性能问题">
                            <i class="fas fa-tachometer-alt me-1"></i>
                            查找性能问题
                        </div>
                        <div class="suggestion-chip" data-suggestion="检查代码质量和重构建议">
                            <i class="fas fa-code me-1"></i>
                            代码质量分析
                        </div>
                        <div class="suggestion-chip" data-suggestion="解释这段代码的功能和潜在问题">
                            <i class="fas fa-question-circle me-1"></i>
                            代码解释
                        </div>
                    </div>
                </div>
            </div>

            <!-- 消息列表将动态添加到这里 -->
        </div>

        <!-- 输入区域 -->
        <div class="chat-input-container">
            <!-- 上下文信息栏 -->
            <div class="context-info" id="contextInfo" style="display: none;">
                <div class="context-details">
                    <i class="fas fa-folder-tree me-2"></i>
                    <span class="context-path" id="contextPath">未选择项目</span>
                    <button class="context-remove-btn" id="contextRemoveBtn" title="移除上下文">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- 输入框区域 -->
            <div class="chat-input-area">
                <div class="input-container">
                    <textarea
                        class="chat-input"
                        id="chatInput"
                        placeholder="输入您的问题或代码分析需求..."
                        rows="1"
                        maxlength="4000"
                    ></textarea>
                    <div class="input-actions">
                        <button class="input-action-btn" id="attachFileBtn" title="附加文件">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-action-btn" id="voiceInputBtn" title="语音输入">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="send-btn" id="sendBtn" title="发送消息 (Enter)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="input-info">
                    <span class="char-count" id="charCount">0 / 4000</span>
                    <span class="input-hint">按 Enter 发送，Shift + Enter 换行</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 项目上下文选择模态框 -->
<div class="modal fade" id="contextModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder-open me-2"></i>
                    选择项目上下文
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="context-tabs">
                    <ul class="nav nav-tabs" id="contextTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#uploadedProjects">
                                已上传项目
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#localProjects">
                                本地路径
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#recentAnalysis">
                                最近分析
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <!-- 已上传项目 -->
                        <div class="tab-pane fade show active" id="uploadedProjects">
                            <div class="projects-list" id="uploadedProjectsList">
                                <!-- 动态填充已上传的项目列表 -->
                                <div class="no-projects">
                                    <i class="fas fa-folder-open me-2"></i>
                                    暂无已上传的项目
                                </div>
                            </div>
                        </div>
                        <!-- 本地路径 -->
                        <div class="tab-pane fade" id="localProjects">
                            <form id="localPathForm">
                                <div class="mb-3">
                                    <label for="localProjectPath" class="form-label">项目路径</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="localProjectPath"
                                               placeholder="/path/to/your/project">
                                        <button class="btn btn-outline-secondary" type="button" id="browseLocalBtn">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">输入本地项目路径以提供代码上下文</div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeTests">
                                        <label class="form-check-label" for="includeTests">
                                            包含测试文件
                                        </label>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="validateLocalPathBtn">
                                        验证路径
                                    </button>
                                </div>
                            </form>
                            <div id="localPathValidation" class="mt-3"></div>
                        </div>
                        <!-- 最近分析 -->
                        <div class="tab-pane fade" id="recentAnalysis">
                            <div class="recent-analysis-list" id="recentAnalysisList">
                                <!-- 动态填充最近分析的项目 -->
                                <div class="no-recent">
                                    <i class="fas fa-history me-2"></i>
                                    暂无最近分析的项目
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmContextBtn" disabled>
                    确认选择
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 设置模态框 -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>
                    深度分析设置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h6>模型设置</h6>
                    <div class="mb-3">
                        <label for="analysisModel" class="form-label">分析模型</label>
                        <select class="form-select" id="analysisModel">
                            <option value="auto">自动选择</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="claude-3">Claude-3</option>
                            <option value="glm-4">GLM-4</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h6>分析设置</h6>
                    <div class="mb-3">
                        <label for="analysisDepth" class="form-label">分析深度</label>
                        <select class="form-select" id="analysisDepth">
                            <option value="quick">快速分析</option>
                            <option value="standard" selected>标准分析</option>
                            <option value="deep">深度分析</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="maxTokens" class="form-label">最大令牌数</label>
                        <input type="number" class="form-control" id="maxTokens" value="4000" min="1000" max="8000">
                    </div>
                </div>

                <div class="settings-section">
                    <h6>显示设置</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="showTimestamps" checked>
                        <label class="form-check-label" for="showTimestamps">
                            显示时间戳
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="enableMarkdown" checked>
                        <label class="form-check-label" for="enableMarkdown">
                            启用Markdown渲染
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enableTypingEffect" checked>
                        <label class="form-check-label" for="enableTypingEffect">
                            启用打字机效果
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">保存设置</button>
            </div>
        </div>
    </div>
</div>

<!-- 语音输入模态框 -->
<div class="modal fade" id="voiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="voice-recording" id="voiceRecording">
                    <div class="voice-icon">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <h5>正在录音...</h5>
                    <p>请说出您的问题</p>
                    <div class="voice-wave">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <button class="btn btn-danger mt-3" id="stopRecordingBtn">
                        <i class="fas fa-stop me-2"></i>
                        停止录音
                    </button>
                </div>
                <div class="voice-processing" id="voiceProcessing" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">处理中...</span>
                    </div>
                    <p class="mt-3">正在转换语音为文字...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelVoiceBtn">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 输入提示模态框 -->
<div class="modal fade" id="inputHintModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body">
                <div class="input-hint-content">
                    <h6>输入提示</h6>
                    <ul class="hint-list">
                        <li><strong>@文件名</strong> - 引用特定文件</li>
                        <li><strong>/help</strong> - 获取帮助信息</li>
                        <li><strong>/clear</strong> - 清空当前会话</li>
                        <li><strong>/export</strong> - 导出会话记录</li>
                        <li><strong>Enter</strong> - 发送消息</li>
                        <li><strong>Shift + Enter</strong> - 换行</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/websocket.js') }}"></script>
<script src="{{ url_for('static', filename='js/deep_analysis.js') }}"></script>
{% endblock %}