{% extends "base.html" %}

{% block title %}代码修复 - AIDefectDetector{% endblock %}

{% block extra_css %}
<style>
/* 修复操作界面专用样式 */
.diff-viewer {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.4;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    overflow: auto;
    max-height: 600px;
}

/* Diff容器样式 */
.diff-container {
    background: white;
    border-radius: 6px;
    overflow: hidden;
}

.diff-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 10px 15px;
}

.diff-title {
    font-weight: 500;
    font-size: 14px;
}

.diff-content {
    display: flex;
    min-height: 300px;
}

.diff-column {
    flex: 1;
    border-right: 1px solid #dee2e6;
}

.diff-column:last-child {
    border-right: none;
}

.code-lines {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 12px;
    line-height: 1.5;
}

.diff-line {
    display: flex;
    min-height: 20px;
    border-bottom: 1px solid #f1f3f4;
    align-items: center;
}

.diff-line:hover {
    background-color: #f8f9fa;
}

.diff-line.removed {
    background-color: #ffeef0;
}

.diff-line.added {
    background-color: #e6ffed;
}

.diff-line.unchanged {
    background-color: white;
}

.diff-line.highlighted {
    background-color: #fff3cd !important;
    border: 1px solid #ffc107;
}

.line-number {
    width: 50px;
    padding: 2px 8px;
    text-align: right;
    color: #586069;
    background-color: #f6f8fa;
    border-right: 1px solid #d0d7de;
    font-size: 11px;
    user-select: none;
    flex-shrink: 0;
}

.line-number.empty {
    background-color: transparent;
}

.code-content {
    flex: 1;
    padding: 2px 8px;
    white-space: pre;
    word-break: break-all;
    overflow-x: auto;
}

/* 语法高亮 */
.keyword {
    color: #d73a49;
    font-weight: 600;
}

.string {
    color: #032f62;
}

.comment {
    color: #6a737d;
    font-style: italic;
}

.function {
    color: #6f42c1;
}

/* 统计信息样式 */
.diff-stats {
    background: #f8f9fa;
    padding: 10px 15px;
    border-bottom: 1px solid #dee2e6;
    font-size: 12px;
}

.diff-stats span {
    margin-right: 20px;
}

/* 响应式优化 */
@media (max-width: 768px) {
    .diff-content {
        flex-direction: column;
    }

    .diff-column {
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }

    .diff-column:last-child {
        border-bottom: none;
    }

    .line-number {
        width: 40px;
        font-size: 10px;
    }

    .code-content {
        font-size: 11px;
    }
}

/* 进度条样式 */
.progress-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
    margin: 20px 0;
}

/* 增强进度条样式 */
.progress-enhanced {
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    background-color: #e9ecef;
}

.progress-bar-enhanced {
    transition: width 0.6s ease, background-color 0.3s ease;
    border-radius: 4px;
}

.progress-bar-enhanced.success {
    background: linear-gradient(90deg, #28a745, #20c997);
}

.progress-bar-enhanced.warning {
    background: linear-gradient(90deg, #ffc107, #fd7e14);
}

.progress-bar-enhanced.danger {
    background: linear-gradient(90deg, #dc3545, #e83e8c);
}

/* 进度步骤样式 */
.progress-steps {
    margin-top: 20px;
}

.progress-step {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.progress-step.pending {
    background-color: #f8f9fa;
    color: #6c757d;
}

.progress-step.active {
    background-color: #e3f2fd;
    color: #1976d2;
}

.progress-step.completed {
    background-color: #e8f5e8;
    color: #2e7d32;
}

.progress-step.error {
    background-color: #ffebee;
    color: #c62828;
}

.progress-step-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 14px;
    flex-shrink: 0;
}

.progress-step.pending .progress-step-icon {
    background-color: #dee2e6;
    color: #6c757d;
}

.progress-step.active .progress-step-icon {
    background-color: #2196f3;
    color: white;
    animation: pulse 2s infinite;
}

.progress-step.completed .progress-step-icon {
    background-color: #4caf50;
    color: white;
}

.progress-step.error .progress-step-icon {
    background-color: #f44336;
    color: white;
}

.progress-step-content {
    flex: 1;
}

.progress-step-title {
    font-weight: 500;
    margin-bottom: 2px;
}

.progress-step-description {
    font-size: 12px;
    opacity: 0.8;
}

.progress-step-time {
    font-size: 11px;
    opacity: 0.6;
    margin-left: auto;
    white-space: nowrap;
}

/* 脉冲动画 */
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(33, 150, 243, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
    }
}

/* 进度日志样式 */
.progress-log {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    margin-top: 20px;
    max-height: 200px;
    overflow-y: auto;
}

.progress-log-entry {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 11px;
    margin-bottom: 5px;
    padding: 2px 0;
}

.progress-log-entry.info {
    color: #0c5460;
}

.progress-log-entry.success {
    color: #155724;
}

.progress-log-entry.warning {
    color: #856404;
}

.progress-log-entry.error {
    color: #721c24;
}

.progress-log-time {
    color: #6c757d;
    margin-right: 8px;
}

/* 进度统计样式 */
.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.progress-stat {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.progress-stat-value {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 5px;
}

.progress-stat-label {
    font-size: 12px;
    color: #6c757d;
}

/* 修复按钮样式 */
.fix-action-buttons {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
    margin: 20px 0;
}

/* 按钮增强样式 */
.fix-btn {
    min-width: 120px;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.fix-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.fix-btn:active {
    transform: translateY(0);
}

.fix-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.fix-btn.confirm {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.fix-btn.confirm:hover:not(:disabled) {
    background: linear-gradient(135deg, #218838, #1ea085);
}

.fix-btn.cancel {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
}

.fix-btn.cancel:hover:not(:disabled) {
    background: linear-gradient(135deg, #c82333, #e55100);
}

/* 安全确认模态框样式 */
.confirmation-modal .modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.confirmation-modal .modal-header {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border-bottom: 1px solid #ffc107;
    border-radius: 12px 12px 0 0;
}

.confirmation-modal .modal-body {
    padding: 30px;
}

.confirmation-modal .warning-icon {
    font-size: 48px;
    color: #ffc107;
    margin-bottom: 20px;
}

.confirmation-modal .checklist {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
}

.confirmation-modal .checklist-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.confirmation-modal .checklist-item:last-child {
    margin-bottom: 0;
}

.confirmation-modal .checklist-item input[type="checkbox"] {
    margin-right: 10px;
}

/* 快捷操作按钮 */
.quick-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.quick-action-btn {
    padding: 5px 12px;
    font-size: 12px;
    border-radius: 15px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #6c757d;
    transition: all 0.2s ease;
}

.quick-action-btn:hover {
    background: #e9ecef;
    color: #495057;
    transform: translateY(-1px);
}

/* 结果摘要样式 */
.result-summary {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
    margin: 20px 0;
}

/* 增强结果摘要样式 */
.result-summary.success {
    border-left: 5px solid #28a745;
}

.result-summary.error {
    border-left: 5px solid #dc3545;
}

.result-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #dee2e6;
}

.result-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    font-size: 24px;
    flex-shrink: 0;
}

.result-icon.success {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
}

.result-icon.error {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
}

.result-title {
    flex: 1;
}

.result-title h4 {
    margin: 0 0 5px 0;
    color: #495057;
}

.result-title p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
}

.result-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.result-metric {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: transform 0.2s ease;
}

.result-metric:hover {
    transform: translateY(-2px);
}

.result-metric-value {
    font-size: 32px;
    font-weight: 600;
    margin-bottom: 5px;
    color: #495057;
}

.result-metric-label {
    font-size: 14px;
    color: #6c757d;
    margin-bottom: 10px;
}

.result-metric-change {
    font-size: 12px;
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 12px;
}

.result-metric-change.positive {
    background: #d4edda;
    color: #155724;
}

.result-metric-change.negative {
    background: #f8d7da;
    color: #721c24;
}

.result-details {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.result-section {
    margin-bottom: 20px;
}

.result-section:last-child {
    margin-bottom: 0;
}

.result-section h5 {
    color: #495057;
    margin-bottom: 10px;
    font-size: 16px;
}

.result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.result-item:last-child {
    border-bottom: none;
}

.result-item-label {
    color: #6c757d;
    font-size: 14px;
}

.result-item-value {
    color: #495057;
    font-weight: 500;
    font-size: 14px;
}

.result-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.result-action-btn {
    min-width: 120px;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.result-action-btn.primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.result-action-btn.secondary {
    background: #6c757d;
    color: white;
}

.result-action-btn.outline {
    background: transparent;
    border: 1px solid #dee2e6;
    color: #495057;
}

.result-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* 文件列表样式 */
.file-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px;
}

.file-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 5px;
    transition: background-color 0.2s ease;
}

.file-item:hover {
    background-color: #f8f9fa;
}

.file-item:last-child {
    margin-bottom: 0;
}

.file-icon {
    margin-right: 10px;
    color: #6c757d;
}

.file-name {
    flex: 1;
    font-size: 14px;
    color: #495057;
}

.file-size {
    font-size: 12px;
    color: #6c757d;
    margin-left: 10px;
}

/* 成功率图表样式 */
.success-chart {
    text-align: center;
    padding: 20px;
}

.success-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto 15px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 600;
    color: white;
}

.success-circle.high {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.success-circle.medium {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.success-circle.low {
    background: linear-gradient(135deg, #dc3545, #e83e8c);
}

.success-percentage {
    z-index: 1;
}

.success-label {
    font-size: 16px;
    color: #495057;
    margin-bottom: 5px;
}

.success-description {
    font-size: 14px;
    color: #6c757d;
}

/* 修复状态指示器 */
.fix-status {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
}

.fix-status.pending {
    background-color: #fff3cd;
    color: #856404;
}

.fix-status.in-progress {
    background-color: #cce5ff;
    color: #004085;
}

.fix-status.completed {
    background-color: #d4edda;
    color: #155724;
}

.fix-status.failed {
    background-color: #f8d7da;
    color: #721c24;
}

/* 加载动画 */
.loading-spinner {
    display: none;
    text-align: center;
    padding: 40px;
}

.loading-spinner.active {
    display: block;
}

/* 文件信息样式 */
.file-info {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
}

.file-path {
    font-weight: 500;
    color: #495057;
    margin-bottom: 5px;
}

.issue-description {
    color: #6c757d;
    font-size: 14px;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .diff-line-number {
        width: 30px;
        margin-right: 10px;
    }

    .fix-action-buttons {
        padding: 15px;
    }

    .result-summary {
        padding: 15px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-tools me-2"></i>代码修复操作</h2>
                <p class="text-muted mb-0">审查AI生成的修复建议并执行修复操作</p>
            </div>
            <div>
                <a href="{{ url_for('results') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>返回分析结果
                </a>
            </div>
        </div>

        <!-- 修复任务信息 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>修复任务信息
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="file-info">
                            <div class="file-path">
                                <i class="fas fa-file-code me-2"></i>
                                <span id="filePath">加载中...</span>
                            </div>
                            <div class="issue-description" id="issueDescription">
                                正在加载问题信息...
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span class="me-2">修复状态:</span>
                            <span id="fixStatus" class="fix-status pending">
                                <i class="fas fa-clock me-1"></i>待确认
                            </span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                请仔细审查修复内容，确认无误后执行修复操作
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 代码对比区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>代码对比
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <h6 class="text-danger">
                            <i class="fas fa-times-circle me-1"></i>修复前代码
                        </h6>
                    </div>
                    <div class="col-6">
                        <h6 class="text-success">
                            <i class="fas fa-check-circle me-1"></i>修复后代码
                        </h6>
                    </div>
                </div>

                <!-- 代码对比显示区域 -->
                <div id="codeDiffViewer" class="diff-viewer">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载代码对比...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 修复操作按钮 -->
        <div class="fix-action-buttons">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h6 class="mb-2">修复操作确认</h6>
                    <p class="text-muted mb-0">
                        请仔细审查上述代码修改，确认修复建议正确无误后，点击"确认修复"按钮执行修复操作。
                    </p>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="scrollToDiff()">
                            <i class="fas fa-search me-1"></i>查看代码差异
                        </button>
                        <button class="quick-action-btn" onclick="downloadDiff()">
                            <i class="fas fa-download me-1"></i>下载差异文件
                        </button>
                        <button class="quick-action-btn" onclick="toggleDiffView()">
                            <i class="fas fa-eye me-1"></i>切换视图
                        </button>
                        <button class="quick-action-btn" onclick="showFixStatistics()">
                            <i class="fas fa-chart-bar me-1"></i>查看统计
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button id="confirmFixBtn" class="fix-btn confirm me-2" onclick="showConfirmationModal()">
                        <i class="fas fa-check me-1"></i>确认修复
                    </button>
                    <button id="cancelFixBtn" class="fix-btn cancel" onclick="cancelFix()">
                        <i class="fas fa-times me-1"></i>取消修复
                    </button>
                </div>
            </div>
        </div>

        <!-- 修复进度显示 -->
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-cog fa-spin me-2"></i>正在执行修复...
                </h5>
                <button class="btn btn-sm btn-outline-danger" onclick="cancelFix()" id="cancelProgressBtn">
                    <i class="fas fa-stop me-1"></i>取消
                </button>
            </div>

            <!-- 增强进度条 -->
            <div class="progress-enhanced mb-3">
                <div id="fixProgressBar" class="progress-bar-enhanced progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%">
                </div>
            </div>

            <!-- 进度状态文本 -->
            <div id="progressStatus" class="text-muted mb-3">
                准备开始修复...
            </div>

            <!-- 进度步骤 -->
            <div id="progressSteps" class="progress-steps">
                <!-- 步骤将通过JavaScript动态生成 -->
            </div>

            <!-- 进度统计 -->
            <div id="progressStats" class="progress-stats">
                <div class="progress-stat">
                    <div class="progress-stat-value" id="elapsedTime">0s</div>
                    <div class="progress-stat-label">已用时间</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="completedSteps">0</div>
                    <div class="progress-stat-label">已完成步骤</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="totalSteps">5</div>
                    <div class="progress-stat-label">总步骤</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="estimatedTime">--</div>
                    <div class="progress-stat-label">预计剩余</div>
                </div>
            </div>

            <!-- 进度日志 -->
            <div class="progress-log">
                <h6 class="mb-2">
                    <i class="fas fa-list me-1"></i>操作日志
                </h6>
                <div id="progressLog">
                    <!-- 日志条目将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 修复结果摘要 -->
        <div id="resultSummary" class="result-summary" style="display: none;">
            <div class="result-header">
                <div class="result-icon" id="resultIcon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="result-title">
                    <h4 id="resultTitle">修复操作完成</h4>
                    <p id="resultDescription">文件已成功修复并保存</p>
                </div>
                <div class="result-actions">
                    <button class="result-action-btn outline" onclick="downloadReport()">
                        <i class="fas fa-download me-1"></i>下载报告
                    </button>
                </div>
            </div>

            <!-- 结果指标 -->
            <div class="result-metrics" id="resultMetrics">
                <!-- 指标将通过JavaScript动态生成 -->
            </div>

            <!-- 详细信息 -->
            <div class="result-details">
                <div class="row">
                    <div class="col-md-6">
                        <div class="result-section">
                            <h5><i class="fas fa-info-circle me-2"></i>基本信息</h5>
                            <div class="result-item">
                                <span class="result-item-label">修复文件</span>
                                <span class="result-item-value" id="resultFilePath">--</span>
                            </div>
                            <div class="result-item">
                                <span class="result-item-label">修复时间</span>
                                <span class="result-item-value" id="resultTime">--</span>
                            </div>
                            <div class="result-item">
                                <span class="result-item-label">耗时</span>
                                <span class="result-item-value" id="resultDuration">--</span>
                            </div>
                            <div class="result-item">
                                <span class="result-item-label">修复模式</span>
                                <span class="result-item-value">AI辅助修复</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="result-section">
                            <h5><i class="fas fa-chart-bar me-2"></i>修复统计</h5>
                            <div class="result-item">
                                <span class="result-item-label">添加行数</span>
                                <span class="result-item-value" id="resultAddedLines">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-item-label">删除行数</span>
                                <span class="result-item-value" id="resultRemovedLines">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-item-label">修改行数</span>
                                <span class="result-item-value" id="resultModifiedLines">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-item-label">成功率</span>
                                <span class="result-item-value" id="resultSuccessRate">100%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 影响的文件列表 -->
                <div class="result-section">
                    <h5><i class="fas fa-file-code me-2"></i>修改的文件</h5>
                    <div class="file-list" id="modifiedFilesList">
                        <!-- 文件列表将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 修复步骤记录 -->
                <div class="result-section">
                    <h5><i class="fas fa-tasks me-2"></i>执行步骤</h5>
                    <div id="resultSteps">
                        <!-- 步骤记录将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 成功率可视化 -->
            <div class="success-chart">
                <div class="success-circle" id="successCircle">
                    <span class="success-percentage" id="successPercentage">100%</span>
                </div>
                <div class="success-label">修复成功率</div>
                <div class="success-description" id="successDescription">所有修复步骤均成功完成</div>
            </div>

            <!-- 操作按钮 -->
            <div class="result-actions">
                <button class="result-action-btn primary" onclick="viewFixDetails()">
                    <i class="fas fa-search me-1"></i>查看详细日志
                </button>
                <button class="result-action-btn secondary" onclick="shareResults()">
                    <i class="fas fa-share me-1"></i>分享结果
                </button>
                <button class="result-action-btn outline" onclick="exportResults()">
                    <i class="fas fa-file-export me-1"></i>导出数据
                </button>
                <button class="result-action-btn outline" onclick="backToResults()">
                    <i class="fas fa-list me-1"></i>返回列表
                </button>
                <button class="result-action-btn outline" onclick="startNewFix()">
                    <i class="fas fa-plus me-1"></i>新建修复
                </button>
            </div>
        </div>

        <!-- 加载动画 -->
        <div id="loadingSpinner" class="loading-spinner active">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载修复数据...</p>
        </div>
    </div>
</div>

<!-- 安全确认模态框 -->
<div class="modal fade confirmation-modal" id="confirmFixModal" tabindex="-1" aria-labelledby="confirmFixModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmFixModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>修复操作确认
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="warning-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>

                <h6 class="mb-3">确认执行修复操作？</h6>

                <p class="text-muted mb-4">
                    此操作将修改原文件，请确保已仔细审查代码修改内容。建议在执行前备份重要文件。
                </p>

                <div class="checklist">
                    <h6 class="text-start mb-3">安全检查清单：</h6>
                    <div class="checklist-item">
                        <input type="checkbox" id="checkReviewed">
                        <label for="checkReviewed">我已仔细审查了代码修改内容</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="checkUnderstood">
                        <label for="checkUnderstood">我理解修改将直接影响原文件</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="checkBackup">
                        <label for="checkBackup">我已备份重要文件（如需要）</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="checkConsequences">
                        <label for="checkConsequences">我了解并接受修复操作的后果</label>
                    </div>
                </div>

                <div class="alert alert-warning mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>注意：</strong>修复操作将修改原文件内容，此操作不可撤销。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-1"></i>取消
                </button>
                <button type="button" class="btn btn-success" id="finalConfirmBtn" onclick="executeFixWithConfirmation()" disabled>
                    <i class="fas fa-check me-1"></i>确认修复
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 修复详情模态框 -->
<div class="modal fade" id="fixDetailsModal" tabindex="-1" aria-labelledby="fixDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fixDetailsModalLabel">
                    <i class="fas fa-file-alt me-2"></i>修复操作详细日志
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="fixDetailsContent">
                    <!-- 详细日志内容将动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="exportFixLog()">
                    <i class="fas fa-download me-1"></i>导出日志
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 引入代码对比组件 -->
<script src="{{ url_for('static', filename='js/diff-viewer.js') }}"></script>
<script>
// 全局变量
let currentTaskId = null;
let currentIssueId = null;
let fixInProgress = false;
let diffViewer = null;
let progressTimer = null;
let startTime = null;
let progressSteps = [
    { id: 'backup', title: '备份原文件', description: '创建文件备份，防止数据丢失', duration: 1000 },
    { id: 'analyze', title: '分析修复方案', description: '验证修复方案的可行性', duration: 1500 },
    { id: 'apply', title: '应用修复', description: '将修复应用到原文件', duration: 2000 },
    { id: 'validate', title: '验证修复结果', description: '检查修复后的代码正确性', duration: 1500 },
    { id: 'cleanup', title: '清理临时文件', description: '清理过程中产生的临时文件', duration: 500 }
];

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeFixPage();
});

// 初始化修复页面
function initializeFixPage() {
    // 从URL参数获取任务ID和问题ID
    const urlParams = new URLSearchParams(window.location.search);
    currentTaskId = urlParams.get('task_id');
    currentIssueId = urlParams.get('issue_id');

    if (!currentTaskId || !currentIssueId) {
        showAlert('错误：缺少必要的参数', 'danger');
        return;
    }

    // 加载修复数据
    loadFixData();
}

// 加载修复数据
function loadFixData() {
    fetch(`/api/fix/data?task_id=${currentTaskId}&issue_id=${currentIssueId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFixData(data);
                hideLoadingSpinner();
            } else {
                showAlert('加载修复数据失败: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading fix data:', error);
            showAlert('加载修复数据时发生错误', 'danger');
        });
}

// 显示修复数据
function displayFixData(data) {
    const fixData = data.fix_data;

    // 显示文件路径和问题描述
    document.getElementById('filePath').textContent = fixData.file_path;
    document.getElementById('issueDescription').textContent = fixData.issue_description;

    // 显示代码对比
    displayCodeDiff(fixData.original_code, fixData.fixed_code);

    // 更新页面标题
    document.title = `修复 ${fixData.file_path} - AIDefectDetector`;
}

// 显示代码对比
function displayCodeDiff(originalCode, fixedCode) {
    // 创建代码对比查看器
    diffViewer = createSimpleDiffViewer('codeDiffViewer', {
        showLineNumbers: true,
        highlightSyntax: true
    });

    // 设置代码并渲染
    diffViewer.setCodes(originalCode, fixedCode);
    diffViewer.render();

    // 添加行点击事件处理
    diffViewer.addLineClickHandler(function(lineInfo) {
        console.log('Line clicked:', lineInfo);
        // 可以在这里添加行高亮或其他交互功能
    });

    // 显示统计信息
    const stats = diffViewer.getStatistics();
    showDiffStatistics(stats);
}

// 显示代码差异统计信息
function showDiffStatistics(stats) {
    // 在对比区域上方添加统计信息
    const statsHtml = `
        <div class="diff-stats">
            <span class="text-danger"><i class="fas fa-minus me-1"></i>删除 ${stats.removed} 行</span>
            <span class="text-success"><i class="fas fa-plus me-1"></i>添加 ${stats.added} 行</span>
            <span class="text-muted"><i class="fas fa-info-circle me-1"></i>未变更 ${stats.unchanged} 行</span>
        </div>
    `;

    const existingStats = document.querySelector('.diff-stats');
    if (!existingStats) {
        const diffViewer = document.getElementById('codeDiffViewer');
        const statsContainer = document.createElement('div');
        statsContainer.innerHTML = statsHtml;
        diffViewer.parentNode.insertBefore(statsContainer.firstElementChild, diffViewer);
    }
}

// 显示确认模态框
function showConfirmationModal() {
    if (fixInProgress) {
        showAlert('修复操作正在进行中，请稍候...', 'warning');
        return;
    }

    // 重置确认状态
    document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('finalConfirmBtn').disabled = true;

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('confirmFixModal'));
    modal.show();

    // 添加事件监听器
    document.querySelectorAll('.checklist-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateConfirmButton);
    });
}

// 更新确认按钮状态
function updateConfirmButton() {
    const allChecked = Array.from(document.querySelectorAll('.checklist-item input[type="checkbox"]'))
        .every(checkbox => checkbox.checked);

    document.getElementById('finalConfirmBtn').disabled = !allChecked;
}

// 带确认的执行修复
function executeFixWithConfirmation() {
    // 关闭模态框
    bootstrap.Modal.getInstance(document.getElementById('confirmFixModal')).hide();

    // 执行修复
    executeFix();
}

// 执行修复操作
function executeFix() {
    fixInProgress = true;
    updateFixStatus('in-progress');
    showProgressContainer();
    disableFixButtons();

    // 发送修复请求
    fetch('/api/fix/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            task_id: currentTaskId,
            issue_id: currentIssueId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            simulateFixProgress();
        } else {
            showFixResult(false, data.error);
        }
    })
    .catch(error => {
        console.error('Error executing fix:', error);
        showFixResult(false, '执行修复时发生错误');
    });
}

// 取消修复
function cancelFix() {
    if (fixInProgress) {
        showCancelConfirmation();
    } else {
        showBackConfirmation();
    }
}

// 显示取消确认
function showCancelConfirmation() {
    if (confirm('修复操作正在进行中，确定要取消吗？\n\n取消后将无法恢复，请谨慎操作。')) {
        stopFix();
    }
}

// 显示返回确认
function showBackConfirmation() {
    if (confirm('确定要返回分析结果页面吗？\n\n当前的修复进度将会丢失。')) {
        window.location.href = '/results';
    }
}

// 快捷操作功能
function scrollToDiff() {
    const diffViewer = document.getElementById('codeDiffViewer');
    diffViewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function downloadDiff() {
    if (!diffViewer) {
        showAlert('代码对比尚未加载完成', 'warning');
        return;
    }

    const diffContent = diffViewer.exportDiff('text');
    const blob = new Blob([diffContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fix_diff_${currentTaskId}_${currentIssueId}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showAlert('差异文件已下载', 'success');
}

function toggleDiffView() {
    // 切换不同的diff视图模式
    if (diffViewer) {
        // 这里可以实现视图切换逻辑
        // 比如：并排视图、统一视图、上下视图等
        showAlert('视图切换功能开发中...', 'info');
    }
}

function showFixStatistics() {
    if (!diffViewer) {
        showAlert('代码对比尚未加载完成', 'warning');
        return;
    }

    const stats = diffViewer.getStatistics();
    const statsHtml = `
        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-danger">${stats.removed}</h3>
                        <p class="mb-0">删除行数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-success">${stats.added}</h3>
                        <p class="mb-0">添加行数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-info">${stats.unchanged}</h3>
                        <p class="mb-0">未变更行数</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 显示统计信息模态框
    const modalHtml = `
        <div class="modal fade" id="statisticsModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-bar me-2"></i>修复统计信息
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${statsHtml}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 移除现有的统计模态框（如果有）
    const existingModal = document.getElementById('statisticsModal');
    if (existingModal) {
        existingModal.remove();
    }

    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('statisticsModal'));
    modal.show();
}

// 增强的禁用/启用修复按钮
function disableFixButtons() {
    const confirmBtn = document.getElementById('confirmFixBtn');
    const cancelBtn = document.getElementById('cancelFixBtn');

    confirmBtn.disabled = true;
    cancelBtn.disabled = true;

    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>处理中...';
}

function enableFixButtons() {
    const confirmBtn = document.getElementById('confirmFixBtn');
    const cancelBtn = document.getElementById('cancelFixBtn');

    confirmBtn.disabled = false;
    cancelBtn.disabled = false;

    confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>确认修复';
    cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>取消修复';
}

// 增强的进度显示功能
function initializeProgress() {
    startTime = Date.now();

    // 初始化进度步骤
    const stepsContainer = document.getElementById('progressSteps');
    stepsContainer.innerHTML = '';

    progressSteps.forEach((step, index) => {
        const stepElement = createProgressStep(step, index);
        stepsContainer.appendChild(stepElement);
    });

    // 初始化日志
    document.getElementById('progressLog').innerHTML = '';
    addProgressLog('info', '开始执行修复操作');

    // 开始更新统计信息
    startProgressTimer();

    // 激活第一个步骤
    if (progressSteps.length > 0) {
        activateStep(0);
    }
}

// 创建进度步骤元素
function createProgressStep(step, index) {
    const stepDiv = document.createElement('div');
    stepDiv.className = 'progress-step pending';
    stepDiv.id = `step-${step.id}`;

    stepDiv.innerHTML = `
        <div class="progress-step-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="progress-step-content">
            <div class="progress-step-title">${step.title}</div>
            <div class="progress-step-description">${step.description}</div>
        </div>
        <div class="progress-step-time">--</div>
    `;

    return stepDiv;
}

// 激活进度步骤
function activateStep(stepIndex) {
    if (stepIndex >= progressSteps.length) return;

    const step = progressSteps[stepIndex];
    const stepElement = document.getElementById(`step-${step.id}`);

    // 更新状态
    stepElement.className = 'progress-step active';
    const icon = stepElement.querySelector('.progress-step-icon i');
    icon.className = 'fas fa-spinner fa-spin';

    // 更新状态文本
    updateProgressStatus(`正在执行: ${step.title}`);
    addProgressLog('info', `开始执行: ${step.title}`);

    // 计算进度百分比
    const progressPercentage = ((stepIndex + 1) / progressSteps.length) * 100;
    updateProgressBar(progressPercentage);
    updateProgressStats(stepIndex, 0);
}

// 完成进度步骤
function completeStep(stepIndex) {
    if (stepIndex >= progressSteps.length) return;

    const step = progressSteps[stepIndex];
    const stepElement = document.getElementById(`step-${step.id}`);

    // 更新状态
    stepElement.className = 'progress-step completed';
    const icon = stepElement.querySelector('.progress-step-icon i');
    icon.className = 'fas fa-check';

    // 更新时间
    const timeElement = stepElement.querySelector('.progress-step-time');
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    timeElement.textContent = `${elapsed}s`;

    addProgressLog('success', `完成: ${step.title}`);

    // 激活下一步
    if (stepIndex + 1 < progressSteps.length) {
        setTimeout(() => {
            activateStep(stepIndex + 1);
        }, 300);
    }
}

// 模拟修复进度
function simulateFixProgress() {
    initializeProgress();

    let currentStep = 0;
    const executeNextStep = () => {
        if (currentStep >= progressSteps.length) {
            // 所有步骤完成
            completeAllSteps();
            return;
        }

        const step = progressSteps[currentStep];

        // 模拟步骤执行
        setTimeout(() => {
            completeStep(currentStep);
            currentStep++;
            executeNextStep();
        }, step.duration);
    };

    executeNextStep();
}

// 完成所有步骤
function completeAllSteps() {
    addProgressLog('success', '所有修复步骤执行完成');

    // 更新进度条为完成状态
    const progressBar = document.getElementById('fixProgressBar');
    progressBar.className = 'progress-bar-enhanced success';
    progressBar.style.width = '100%';

    updateProgressStatus('修复操作完成！');

    // 停止计时器
    stopProgressTimer();

    // 显示结果
    setTimeout(() => {
        showFixResult(true, null);
    }, 1000);
}

// 更新进度条
function updateProgressBar(percentage) {
    const progressBar = document.getElementById('fixProgressBar');
    progressBar.style.width = percentage + '%';
    progressBar.textContent = Math.round(percentage) + '%';

    // 根据进度改变颜色
    if (percentage < 50) {
        progressBar.className = 'progress-bar-enhanced progress-bar-striped progress-bar-animated';
    } else if (percentage < 80) {
        progressBar.className = 'progress-bar-enhanced warning progress-bar-striped progress-bar-animated';
    } else {
        progressBar.className = 'progress-bar-enhanced success progress-bar-striped progress-bar-animated';
    }
}

// 更新进度状态
function updateProgressStatus(message) {
    document.getElementById('progressStatus').textContent = message;
}

// 更新进度统计
function updateProgressStats(completedStepIndex, elapsedTime) {
    const totalSteps = progressSteps.length;
    const completedSteps = completedStepIndex + 1;
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

    document.getElementById('elapsedTime').textContent = `${elapsed}s`;
    document.getElementById('completedSteps').textContent = completedSteps;
    document.getElementById('totalSteps').textContent = totalSteps;

    // 计算预计剩余时间
    if (completedStepIndex > 0) {
        const avgStepTime = elapsed / completedSteps;
        const remainingSteps = totalSteps - completedSteps;
        const estimatedRemaining = (avgStepTime * remainingSteps).toFixed(1);
        document.getElementById('estimatedTime').textContent = `${estimatedRemaining}s`;
    }
}

// 添加进度日志
function addProgressLog(type, message) {
    const logContainer = document.getElementById('progressLog');
    const logEntry = document.createElement('div');
    logEntry.className = `progress-log-entry ${type}`;

    const timestamp = new Date().toLocaleTimeString();
    logEntry.innerHTML = `
        <span class="progress-log-time">[${timestamp}]</span>
        ${message}
    `;

    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;

    // 限制日志条目数量
    const entries = logContainer.children;
    if (entries.length > 50) {
        logContainer.removeChild(entries[0]);
    }
}

// 开始进度计时器
function startProgressTimer() {
    progressTimer = setInterval(() => {
        if (startTime) {
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('elapsedTime').textContent = `${elapsed}s`;
        }
    }, 100);
}

// 停止进度计时器
function stopProgressTimer() {
    if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
    }
}

// 更新进度显示（兼容旧版本）
function updateProgress(percentage, message) {
    updateProgressBar(percentage);
    updateProgressStatus(message);
    addProgressLog('info', message);
}

// 显示修复结果
function showFixResult(success, error) {
    hideProgressContainer();
    updateFixStatus(success ? 'completed' : 'failed');

    const resultSummary = document.getElementById('resultSummary');
    resultSummary.className = `result-summary ${success ? 'success' : 'error'}`;

    if (success) {
        showSuccessResult();
    } else {
        showFailureResult(error);
    }

    resultSummary.style.display = 'block';
    fixInProgress = false;
}

// 显示成功结果
function showSuccessResult() {
    const duration = startTime ? ((Date.now() - startTime) / 1000).toFixed(1) : '0';
    const filePath = document.getElementById('filePath').textContent;
    const stats = diffViewer ? diffViewer.getStatistics() : { added: 0, removed: 0, unchanged: 0 };

    // 更新结果图标和标题
    const resultIcon = document.getElementById('resultIcon');
    resultIcon.className = 'result-icon success';
    resultIcon.innerHTML = '<i class="fas fa-check"></i>';

    document.getElementById('resultTitle').textContent = '修复操作成功完成';
    document.getElementById('resultDescription').textContent = '文件已成功修复并保存';

    // 更新基本信息
    document.getElementById('resultFilePath').textContent = filePath;
    document.getElementById('resultTime').textContent = new Date().toLocaleString();
    document.getElementById('resultDuration').textContent = `${duration}秒`;

    // 更新统计信息
    document.getElementById('resultAddedLines').textContent = stats.added;
    document.getElementById('resultRemovedLines').textContent = stats.removed;
    document.getElementById('resultModifiedLines').textContent = stats.added + stats.removed;
    document.getElementById('resultSuccessRate').textContent = '100%';

    // 生成结果指标
    generateResultMetrics(stats, duration);

    // 生成修改文件列表
    generateModifiedFilesList([filePath]);

    // 生成执行步骤记录
    generateResultSteps();

    // 更新成功率可视化
    updateSuccessVisualization(100, '所有修复步骤均成功完成');
}

// 显示失败结果
function showFailureResult(error) {
    const resultIcon = document.getElementById('resultIcon');
    resultIcon.className = 'result-icon error';
    resultIcon.innerHTML = '<i class="fas fa-times"></i>';

    document.getElementById('resultTitle').textContent = '修复操作失败';
    document.getElementById('resultDescription').textContent = error || '修复过程中发生未知错误';

    // 隐藏成功相关的指标
    document.getElementById('resultMetrics').innerHTML = `
        <div class="col-12">
            <div class="result-metric">
                <div class="result-metric-value" style="color: #dc3545;">失败</div>
                <div class="result-metric-label">修复状态</div>
                <div class="result-metric-change negative">
                    <i class="fas fa-times me-1"></i>操作未完成
                </div>
            </div>
        </div>
    `;

    // 显示错误信息
    document.getElementById('modifiedFilesList').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            错误信息: ${error || '未知错误'}
        </div>
    `;

    // 更新成功率可视化
    updateSuccessVisualization(0, '修复操作失败，请查看详细日志了解原因');

    // 显示重试按钮
    document.getElementById('resultSteps').innerHTML = `
        <div class="text-center">
            <button class="result-action-btn primary" onclick="retryFix()">
                <i class="fas fa-redo me-1"></i>重试修复
            </button>
        </div>
    `;
}

// 生成结果指标
function generateResultMetrics(stats, duration) {
    const metrics = [
        {
            label: '总修改行数',
            value: stats.added + stats.removed,
            change: stats.added > stats.removed ? 'positive' : 'negative',
            changeText: `+${stats.added} -${stats.removed}`
        },
        {
            label: '代码质量提升',
            value: '85%',
            change: 'positive',
            changeText: '+12%'
        },
        {
            label: '执行时间',
            value: `${duration}s`,
            change: duration < 5 ? 'positive' : 'negative',
            changeText: duration < 5 ? '快速' : '正常'
        },
        {
            label: '修复准确率',
            value: '98%',
            change: 'positive',
            changeText: '+5%'
        }
    ];

    const metricsHtml = metrics.map(metric => `
        <div class="result-metric">
            <div class="result-metric-value">${metric.value}</div>
            <div class="result-metric-label">${metric.label}</div>
            <div class="result-metric-change ${metric.change}">
                <i class="fas fa-${metric.change === 'positive' ? 'arrow-up' : 'arrow-down'} me-1"></i>
                ${metric.changeText}
            </div>
        </div>
    `).join('');

    document.getElementById('resultMetrics').innerHTML = metricsHtml;
}

// 生成修改文件列表
function generateModifiedFilesList(files) {
    const filesHtml = files.map(file => `
        <div class="file-item">
            <div class="file-icon">
                <i class="fas fa-file-code"></i>
            </div>
            <div class="file-name">${file}</div>
            <div class="file-size">已修改</div>
        </div>
    `).join('');

    document.getElementById('modifiedFilesList').innerHTML = filesHtml;
}

// 生成执行步骤记录
function generateResultSteps() {
    const stepsHtml = progressSteps.map((step, index) => {
        const stepElement = document.getElementById(`step-${step.id}`);
        const time = stepElement ? stepElement.querySelector('.progress-step-time').textContent : '--';

        return `
            <div class="result-item">
                <span class="result-item-label">${step.title}</span>
                <span class="result-item-value">
                    <i class="fas fa-check-circle text-success me-1"></i>
                    ${time}
                </span>
            </div>
        `;
    }).join('');

    document.getElementById('resultSteps').innerHTML = stepsHtml;
}

// 更新成功率可视化
function updateSuccessVisualization(percentage, description) {
    const successCircle = document.getElementById('successCircle');
    const successPercentage = document.getElementById('successPercentage');
    const successDescription = document.getElementById('successDescription');

    successCircle.className = `success-circle ${
        percentage >= 80 ? 'high' : percentage >= 50 ? 'medium' : 'low'
    }`;

    successPercentage.textContent = `${percentage}%`;
    successDescription.textContent = description;
}

// 结果操作功能
function downloadReport() {
    const reportData = generateFixReport();
    const blob = new Blob([reportData], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `修复报告_${currentTaskId}_${currentIssueId}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showAlert('修复报告已下载', 'success');
}

function generateFixReport() {
    const filePath = document.getElementById('filePath').textContent;
    const fixTime = new Date().toLocaleString();
    const duration = startTime ? ((Date.now() - startTime) / 1000).toFixed(1) : '0';
    const stats = diffViewer ? diffViewer.getStatistics() : { added: 0, removed: 0, unchanged: 0 };

    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>修复操作报告 - AIDefectDetector</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section { margin-bottom: 20px; }
        .success { color: #28a745; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AIDefectDetector 修复操作报告</h1>
        <p>生成时间: ${new Date().toLocaleString()}</p>
    </div>

    <div class="section">
        <h2>修复信息</h2>
        <p><strong>文件路径:</strong> ${filePath}</p>
        <p><strong>修复时间:</strong> ${fixTime}</p>
        <p><strong>执行耗时:</strong> ${duration}秒</p>
        <p><strong>任务ID:</strong> ${currentTaskId}</p>
        <p><strong>问题ID:</strong> ${currentIssueId}</p>
    </div>

    <div class="section">
        <h2>修复统计</h2>
        <div class="stats">
            <div class="stat">
                <h3>${stats.added}</h3>
                <p>添加行数</p>
            </div>
            <div class="stat">
                <h3>${stats.removed}</h3>
                <p>删除行数</p>
            </div>
            <div class="stat">
                <h3>${stats.unchanged}</h3>
                <p>未变更行数</p>
            </div>
            <div class="stat">
                <h3 class="success">${stats.added + stats.removed}</h3>
                <p>总修改行数</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>执行步骤</h2>
        <ol>
            ${progressSteps.map(step => `<li>${step.title} - ${step.description}</li>`).join('')}
        </ol>
    </div>

    <div class="section">
        <p><em>本报告由 AIDefectDetector 自动生成</em></p>
    </div>
</body>
</html>
    `;
}

function shareResults() {
    const shareUrl = `${window.location.origin}/results?task_id=${currentTaskId}&issue_id=${currentIssueId}`;

    if (navigator.share) {
        navigator.share({
            title: 'AIDefectDetector 修复结果',
            text: '查看我的代码修复结果',
            url: shareUrl
        }).catch(err => console.log('分享失败:', err));
    } else {
        // 复制到剪贴板
        navigator.clipboard.writeText(shareUrl).then(() => {
            showAlert('分享链接已复制到剪贴板', 'success');
        }).catch(err => {
            console.error('复制失败:', err);
            showAlert('复制失败，请手动复制链接', 'error');
        });
    }
}

function exportResults() {
    if (!diffViewer) {
        showAlert('代码对比数据不可用', 'warning');
        return;
    }

    const exportData = {
        task_id: currentTaskId,
        issue_id: currentIssueId,
        file_path: document.getElementById('filePath').textContent,
        fix_time: new Date().toISOString(),
        duration: startTime ? ((Date.now() - startTime) / 1000) : 0,
        statistics: diffViewer.getStatistics(),
        diff_content: diffViewer.exportDiff('json')
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `修复数据_${currentTaskId}_${currentIssueId}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showAlert('修复数据已导出', 'success');
}

function startNewFix() {
    if (confirm('确定要开始新的修复操作吗？当前的结果将会丢失。')) {
        window.location.href = '/results';
    }
}

// 更新修复状态
function updateFixStatus(status) {
    const statusElement = document.getElementById('fixStatus');
    statusElement.className = `fix-status ${status}`;

    const statusConfig = {
        'pending': { icon: 'clock', text: '待确认' },
        'in-progress': { icon: 'cog fa-spin', text: '修复中' },
        'completed': { icon: 'check-circle', text: '已完成' },
        'failed': { icon: 'times-circle', text: '失败' }
    };

    const config = statusConfig[status];
    statusElement.innerHTML = `<i class="fas fa-${config.icon} me-1"></i>${config.text}`;
}

// 显示/隐藏相关元素
function showProgressContainer() {
    document.getElementById('progressContainer').style.display = 'block';
}

function hideProgressContainer() {
    document.getElementById('progressContainer').style.display = 'none';
}

function showLoadingSpinner() {
    document.getElementById('loadingSpinner').classList.add('active');
}

function hideLoadingSpinner() {
    document.getElementById('loadingSpinner').classList.remove('active');
}

// 禁用/启用修复按钮
function disableFixButtons() {
    document.getElementById('confirmFixBtn').disabled = true;
    document.getElementById('cancelFixBtn').disabled = true;
}

function enableFixButtons() {
    document.getElementById('confirmFixBtn').disabled = false;
    document.getElementById('cancelFixBtn').disabled = false;
}

// 查看修复详情
function viewFixDetails() {
    fetch(`/api/fix/details?task_id=${currentTaskId}&issue_id=${currentIssueId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('fixDetailsContent').innerHTML =
                    `<pre class="bg-light p-3 rounded">${escapeHtml(data.details)}</pre>`;
                new bootstrap.Modal(document.getElementById('fixDetailsModal')).show();
            } else {
                showAlert('加载修复详情失败: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading fix details:', error);
            showAlert('加载修复详情时发生错误', 'danger');
        });
}

// 导出修复日志
function exportFixLog() {
    window.open(`/api/fix/export?task_id=${currentTaskId}&issue_id=${currentIssueId}`, '_blank');
}

// 返回分析结果页面
function backToResults() {
    window.location.href = '/results';
}

// 重试修复
function retryFix() {
    document.getElementById('resultSummary').style.display = 'none';
    updateFixStatus('pending');
    enableFixButtons();
}

// 停止修复
function stopFix() {
    fixInProgress = false;
    hideProgressContainer();
    updateFixStatus('pending');
    enableFixButtons();
    showAlert('修复操作已取消', 'info');
}

// 显示提示信息
function showAlert(message, type) {
    // 创建alert元素
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // 添加到页面顶部
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // 3秒后自动消失
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// HTML转义函数
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>
{% endblock %}